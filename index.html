<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HAQ Simple Chat (Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">

  <style>
    .quran-arabic { font-family: 'Amiri', serif; font-size: 22px; direction: rtl; text-align: right; margin-bottom: 8px; }
    .message-bot { background:#f4f4f4; padding:10px 14px; border-radius:10px; margin:8px 0; }
    .message-user { background:#000; color:#fff; padding:10px 14px; border-radius:10px; margin:8px 0; text-align:right; }
    .chat-box { max-width:800px; margin:20px auto 0; height:70vh; border:1px solid #ccc; overflow-y:auto; padding:20px; background:#fff; }
    .input-area { max-width:800px; margin:12px auto; display:flex; gap:8px; padding:10px; }
    #userInput { flex:1; padding:12px; font-size:16px; }
    button { padding:10px 14px; cursor:pointer; }
    .auth-popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; }
    .auth-box { background:#fff; padding:20px; border-radius:8px; width:320px; }
    .auth-box input { width:100%; padding:10px; margin-top:8px; }
  </style>
</head>
<body>

  <!-- Auth modal -->
  <div class="auth-popup" id="authScreen">
    <div class="auth-box">
      <h3>Login / Register</h3>
      <input id="authEmail" type="email" placeholder="Email">
      <input id="authPass" type="password" placeholder="Password">
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="loginBtn">Login</button>
        <button id="registerBtn">Register</button>
        <button id="closeAuthBtn">Close</button>
      </div>
      <p id="authMsg" style="color:red;margin-top:8px;"></p>
    </div>
  </div>

  <h2 style="text-align:center;margin-top:18px;">HAQ Chat</h2>

  <div class="chat-box" id="messages" aria-live="polite" role="log"></div>

  <div class="input-area">
    <input id="userInput" placeholder="Ask something..." autocomplete="off" />
    <button id="islamBtn" title="What does Islam say about">?</button>
    <button id="findBtn" title="Find">Find</button>
    <button id="sendBtn" disabled>Send</button>
  </div>

  <!-- Main module script: imports Firebase modules and the app logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "REPLACE",
      authDomain: "REPLACE",
      projectId: "REPLACE",
      storageBucket: "REPLACE",
      messagingSenderId: "REPLACE",
      appId: "REPLACE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- STATE ----------
    let currentUser = null;
    let quranArabic = null;
    let quranEnglish = null;

    // ---------- DOM ----------
    const messagesDiv = document.getElementById("messages");
    const inputEl = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const islamBtn = document.getElementById("islamBtn");
    const findBtn = document.getElementById("findBtn");

    const authScreen = document.getElementById("authScreen");
    const authEmail = document.getElementById("authEmail");
    const authPass = document.getElementById("authPass");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const closeAuthBtn = document.getElementById("closeAuthBtn");
    const authMsg = document.getElementById("authMsg");

    // ---------- UTIL ----------
    function safeText(s){ return s===undefined||s===null ? "" : String(s); }

    function appendUser(text){
      const d = document.createElement("div");
      d.className = "message-user";
      d.textContent = text;
      messagesDiv.appendChild(d);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      saveMessageToFirestore('user', text);
    }

    function appendBotHtml(html){
      const d = document.createElement("div");
      d.className = "message-bot";
      d.innerHTML = html;
      messagesDiv.appendChild(d);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      saveMessageToFirestore('bot', html);
    }

    // ---------- LOAD QURAN (defensive) ----------
    async function loadQuran(){
      try {
        const [aRes, eRes] = await Promise.all([
          fetch("quran.json"),
          fetch("quran_english.json")
        ]);
        if (!aRes.ok) throw new Error("Failed to fetch quran.json: " + aRes.status);
        if (!eRes.ok) throw new Error("Failed to fetch quran_english.json: " + eRes.status);
        quranArabic = await aRes.json();
        quranEnglish = await eRes.json();
        console.log("Quran files loaded");
      } catch (err) {
        console.error("Error loading Quran files:", err);
        appendBotHtml("Error loading Quran data. Ensure <code>data/quran.json</code> and <code>data/quran_english.json</code> exist and are served via HTTP.");
      }
    }
    loadQuran();

    // ---------- PARSER ----------
    function parseQuery(q){
      if(!q) return null;
      const text = q.toLowerCase().trim();

      // 1) colon e.g. 2:255
      const m1 = text.match(/^(\\d{1,3})\\s*:\\s*(\\d{1,3})$/);
      if(m1) return { type: "ayah", surah: Number(m1[1]), ayah: Number(m1[2]) };

      // 2) "chapter 1 verse 2" or "surah 2 ayah 255"
      const m2 = text.match(/(chapter|surah)\\s+(\\d{1,3}).*?(verse|ayah|ayat)\\s*(\\d{1,3})/);
      if(m2) return { type: "ayah", surah: Number(m2[2]), ayah: Number(m2[4]) };

      // 3) whole chapter: "chapter 2" or "surah 36"
      const m3 = text.match(/(?:chapter|surah)\\s+(\\d{1,3})$/);
      if(m3) return { type: "chapter", surah: Number(m3[1]) };

      return null;
    }

    // ---------- LOOKUPS ----------
    function getSurahArabic(num){
      return quranArabic && quranArabic.data && Array.isArray(quranArabic.data.surahs)
        ? quranArabic.data.surahs.find(s => Number(s.number) === Number(num))
        : null;
    }

    function getSurahEnglish(num){
      return quranEnglish && quranEnglish.data && Array.isArray(quranEnglish.data.surahs)
        ? quranEnglish.data.surahs.find(s => Number(s.number) === Number(num))
        : null;
    }

    function getAyah(surah, ayah){
      const sA = getSurahArabic(surah);
      const sE = getSurahEnglish(surah);
      if(!sA || !sE) return null;
      const aA = Array.isArray(sA.ayahs) ? sA.ayahs.find(x => Number(x.numberInSurah) === Number(ayah)) : null;
      const aE = Array.isArray(sE.ayahs) ? sE.ayahs.find(x => Number(x.numberInSurah) === Number(ayah)) : null;
      if(!aA || !aE) return null;
      return { name: safeText(sA.englishName), arabic: safeText(aA.text), english: safeText(aE.text) };
    }

    function getFullChapter(surah){
      const sA = getSurahArabic(surah);
      const sE = getSurahEnglish(surah);
      if(!sA || !sE) return null;
      return {
        name: safeText(sA.englishName),
        arabic: Array.isArray(sA.ayahs) ? sA.ayahs.map(x => ({ num: x.numberInSurah, text: x.text })) : [],
        english: Array.isArray(sE.ayahs) ? sE.ayahs.map(x => ({ num: x.numberInSurah, text: x.text })) : []
      };
    }

    // ---------- FIRESTORE SAVE (only when signed-in) ----------
    function ensureChatId(){
      let id = localStorage.getItem("lastChatId");
      if(!id){
        id = "chat_" + Date.now();
        localStorage.setItem("lastChatId", id);
      }
      return id;
    }

    async function saveMessageToFirestore(role, content){
      if(!currentUser) return;
      try {
        const uid = currentUser.uid;
        const chatId = ensureChatId();
        await addDoc(collection(db, "users", uid, "chats", chatId, "messages"), {
          role: role,
          content: content,
          createdAt: serverTimestamp()
        });
        await setDoc(doc(db, "users", uid, "chats", chatId), { lastUpdated: serverTimestamp(), title: localStorage.getItem(chatId + "_title") || null }, { merge: true });
      } catch (err) {
        console.warn("saveMessageToFirestore failed", err);
      }
    }

    // ---------- PROCESS MESSAGE ----------
    function processQuranRequest(text){
      const parsed = parseQuery(text);
      if(!parsed) return null;

      if(parsed.type === "ayah"){
        const r = getAyah(parsed.surah, parsed.ayah);
        if(!r) return "<div>Ayah not found. Check chapter and verse numbers.</div>";
        var out = "";
        out += "<div class='quran-arabic'>" + escapeHtml(r.arabic) + "</div>";
        out += "<div style='margin-top:8px; font-weight:700;'>" + escapeHtml(r.name) + " " + parsed.surah + ":" + parsed.ayah + "</div>";
        out += "<div style='margin-top:6px;'>" + escapeHtml(r.english) + "</div>";
        return out;
      }

      if(parsed.type === "chapter"){
        const ch = getFullChapter(parsed.surah);
        if(!ch) return "<div>Chapter not found.</div>";
        var html = "<div style='font-weight:700;margin-bottom:8px;'>" + escapeHtml(ch.name) + " â€” Surah " + parsed.surah + "</div>";
        for(var i = 0; i < ch.arabic.length; i++){
          var a = ch.arabic[i];
          var e = ch.english[i] || { text: "" };
          html += "<div style='margin-bottom:10px;'><div style='font-weight:600'>Ayah " + escapeHtml(String(a.num)) + "</div>";
          html += "<div class='quran-arabic'>" + escapeHtml(a.text) + "</div>";
          html += "<div style='margin-top:6px;'>" + escapeHtml(e.text) + "</div></div><hr />";
        }
        return html;
      }
      return null;
    }

    function escapeHtml(str){
      if(str === undefined || str === null) return "";
      return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[m]; });
    }

    // ---------- SEND HANDLER ----------
    function sendMessage(){
      var text = inputEl.value.trim();
      if(!text) return;
      appendUser(text);
      inputEl.value = "";
      sendBtn.disabled = true;

      var qRes = processQuranRequest(text);
      if(qRes !== null){
        appendBotHtml(qRes);
        return;
      }

      // fallback
      appendBotHtml("I couldn't detect a Quran query. Try 'find chapter 2' or '2:255' or 'chapter 1 verse 1'.");
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("input", function(){ sendBtn.disabled = !inputEl.value.trim(); });
    inputEl.addEventListener("keydown", function(e){ if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    // ---------- quick buttons ----------
    islamBtn.addEventListener("click", function(){
      inputEl.value = "What does Islam say about ";
      inputEl.focus();
      sendBtn.disabled = false;
    });
    findBtn.addEventListener("click", function(){
      inputEl.value = "find chapter ";
      inputEl.focus();
      sendBtn.disabled = false;
    });

    // ---------- AUTH ----------
    closeAuthBtn.addEventListener("click", function(){ authScreen.style.display = "none"; authMsg.textContent = ""; });
    loginBtn.addEventListener("click", async function(){
      try{
        await signInWithEmailAndPassword(auth, authEmail.value, authPass.value);
        authScreen.style.display = "none";
        authMsg.textContent = "";
      } catch(err){
        authMsg.textContent = err.message || "Login failed";
      }
    });
    registerBtn.addEventListener("click", async function(){
      try{
        const cred = await createUserWithEmailAndPassword(auth, authEmail.value, authPass.value);
        await setDoc(doc(db, "users", cred.user.uid), { email: authEmail.value, createdAt: serverTimestamp() });
        authScreen.style.display = "none";
        authMsg.textContent = "";
      } catch(err){
        authMsg.textContent = err.message || "Register failed";
      }
    });

    onAuthStateChanged(auth, function(user){
      currentUser = user;
      if(user){
        appendBotHtml("Signed in as: " + escapeHtml(user.email));
      } else {
        appendBotHtml("You are not signed in. Sign in to save chats.");
      }
    });

  </script>
</body>
</html>